# S3 Transfer from DNAnexus platform

## What Does this App Do?

This app will upload file(s) to an external S3 bucket.

## Which files can be transferred?

Any **file** on the platform. Apps and other DNAnexus objects cannot be transferred with this app.

## How Does this App Work?

This app uses AWS CLI (Amazon Web Services Command Line Interface) to upload files to S3. Uploads are performed as a stream from our platform to the specified S3 bucket using the [cp command](http://docs.aws.amazon.com/cli/latest/reference/s3/cp.html). In addition to the file array and upload destination parameters, you must also provide a configuration file with AWS access and secret access key.

A sample configuration text file is shown below:

>[default]  
>aws_access_key_id=[Access key generated by AWS]  
>aws_secret_access_key=[Secret Access key generated by AWS]  
>region=[Region]  

In addition to any other default configurations related to your S3 buckets, configuration files can be created manually if the access, secret access, and region are known. Alternatively, access keys and the configuration file can be generated and uploaded to the platform. Access keys, which are provided for download only once, [must be created](http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-set-up.html#cli-signup) first. Once the access keys are known, you can either use AWS CLI to [autogenerate a config file](http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html) and upload to the platform or manually create a valid config file.

## Special Note on Config Files

Config files contain access keys that, depending on your usage, you may want to keep secret. The following approach uses two projects to keep the contents of a config file secret in a shared project.

*Project A*: Only you (app runner) and trusted individuals have at least VIEW access. Store the `config file` in this project.

Project B: The shared project you want to transfer files from. Run the app in this project and use the `config file` from *Project A* as an input.

Only those with VIEW access to *Project A* can see the contents of the config file in *Project B*. Note that admins in *Project B* can still SSH into a job running in *Project B*.

## Important notes

If an upload fails with a file larger than 8MB, please be aware that the uploaded portions are still present in your S3 bucket, even though you cannot see the object(s). To avoid being continuously charged for incomplete uploads set a [lifecycle configuration policy](http://docs.aws.amazon.com/AmazonS3/latest/dev/mpuoverview.html) for your AWS account.

The only option used is "--expected-size".  While the app allows for other options, be aware that some options (e.g. --recursive) do not work with stream uploads.

## Common Issues

In order for the App to transfer objects to an external S3 bucket, the IAM policy used by the config file **MUST** grant **PutObject access to objects in the S3 bucket**. Below is a correct IAM policy configuration:

```json
{
  "Version": "20xx-xx-xx",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["s3:ListBucket"],
      "Resource": ["arn:aws:s3:::test"]
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject"
      ],
      "Resource": ["arn:aws:s3:::test/*"]
    }
  ]
}
```

The **Resource** property is a common oversight. remember to specify all objects in the bucket with `bucket/*`. Amazon has various [resources](https://aws.amazon.com/blogs/security/writing-iam-policies-how-to-grant-access-to-an-amazon-s3-bucket/) and [examples](http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_examples.html) of IAM policies.
